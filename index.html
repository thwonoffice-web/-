<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í˜‘ë ¥ì‚¬ì—…ë³¸ë¶€ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
/* [ê¸°ë³¸ ë ˆì´ì•„ì›ƒ] */
body{font-family:'Noto Sans KR',sans-serif;background:#f4f6fb;margin:0;color:#333;}
header{background:#fff;border-bottom:1px solid #e5e8f0;padding:16px 24px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center;}
.logo { font-size: 20px; font-weight: 700; color: #4f6fdc; cursor: pointer; }

/* [í™”ë©´ ì „í™˜] */
section { display: none; }
section.active { display: block; }

.admin-badge { font-size: 12px; padding: 4px 10px; border-radius: 6px; margin-left: 15px; font-weight: 600; display: none; vertical-align: middle; background: #4f6fdc; color: #fff; }

/* [í•˜ë‹¨ ë¡œê³ ] */
footer { width: 100%; padding: 40px 0 60px 0; display: flex; justify-content: center; align-items: center; }
.admin-login-img { cursor: pointer; width: 220px; opacity: 1; transition: transform 0.2s; }
.admin-login-img:hover { transform: scale(1.05); }

/* [ëŒ€ì‹œë³´ë“œ & ë²„íŠ¼] */
main{max-width:1200px;margin:30px auto; min-height: 70vh;}
.dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; padding: 40px 20px; }
.dash-btn { aspect-ratio: 1/0.5; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; cursor: pointer; border: 1px solid #e5e8f0; border-radius: 32px; background: #fff; color: #4f6fdc; font-size: 22px; font-weight: 700; box-shadow: 0 10px 30px rgba(79,111,220,0.08); transition: 0.2s; }
.dash-btn span { font-size: 50px; }
.dash-btn:hover { transform: translateY(-5px); background: #4f6fdc; color: #fff; }
.budget-icon { color: #2e7d32; }

/* [ê¸°íƒ€ UI] */
.card{background:#fff;padding:24px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.05);margin-bottom:20px}
button{cursor:pointer;border:none;border-radius:12px;padding:8px 14px;background:#e9edfb;color:#4f6fdc; font-weight: 600;}
.nav { display: flex; gap: 8px; margin: 20px 0; }
.nav button{border-radius:999px;padding:10px 20px; background: #fff; border: 1px solid #dcdfea; color: #666;}
.nav button.active{background:#4f6fdc;color:#fff; border-color: #4f6fdc;}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px 8px;text-align:center;border-bottom:1px solid #e6e9f2; font-size: 13px}
th{background:#f6f8ff; color: #555;}
.bg-kuk { background-color: #f0f4ff !important; color: #3b5bdb; }
.bg-si { background-color: #fff9f0 !important; color: #d26900; }
.total-cell { background-color: #f8faff; font-weight: 800; color: #4f6fdc; }

/* [ì˜ˆì‚° ê´€ë¦¬ ì „ìš©] */
.budget-input { width: 90%; text-align: right; border: 1px solid #ddd; padding: 4px; border-radius: 4px; font-size: 13px; }
.budget-select { padding: 4px; border-radius: 4px; border: 1px solid #ddd; width: 95%; }
.row-kuk { background-color: #f8faff; font-weight: bold; color: #3b5bdb; vertical-align: middle; }
.row-si { background-color: #fffbf5; font-weight: bold; color: #d26900; vertical-align: middle; }
.row-cat { font-weight: bold; vertical-align: middle; background-color: #fafafa; }
.sub-item { color: #555; }

/* [ì§€ì¶œë‚´ì—­ ê²€ìƒ‰ë°”: ì¬ì›/ë¹„ëª©/ì„¸ëª©] */
.filter-bar{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr auto;
  gap:10px;
  align-items:end;
  margin-top:14px;
  padding:12px;
  background:#f8faff;
  border:1px solid #e5e8f0;
  border-radius:14px;
}
.filter-item{display:flex; flex-direction:column; gap:6px;}
.filter-item label{font-size:12px; color:#666; font-weight:700; text-align:left;}
.filter-item select{
  width:100%;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #dcdfea;
  background:#fff;
  font-size:13px;
}
.filter-actions{display:flex; gap:8px; justify-content:flex-end;}
.filter-actions button{border-radius:10px; padding:9px 12px;}
.filter-summary{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; font-size:13px; color:#666;}
.summary-item { padding:12px; border-radius:10px; text-align:center; }
.summary-item.count { background:#f0f4ff; color:#3b5bdb; border: 1px solid #3b5bdb; }
.summary-item.sum { background:#fff9f0; color:#d26900; border: 1px solid #d26900; }

/* [ëª¨ë‹¬] */
#loginModal {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
}
.modal-content { background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 300px; }

.month-tabs{display:flex;gap:6px;flex-wrap:wrap; margin-bottom: 15px;}
.month-tabs button{border-radius:999px; font-size: 13px;}
.month-tabs button.active{background:#4f6fdc;color:#fff}
.summary{display:flex;gap:20px;margin-bottom:20px}
.summary div{flex:1;padding:18px;border-radius:14px;text-align:center;font-weight:700}
input{padding: 5px; border-radius: 5px; border: 1px solid #ddd;}

/* ì§‘í–‰ë¥  ìŠ¤íƒ€ì¼ */
.execution-rate { font-weight: 700; }
.execution-rate.high { color: #d9480f; }
.execution-rate.medium { color: #fab005; }
.execution-rate.low { color: #51cf66; }

/* ì§‘í–‰ë¥  ìš”ì•½ ìŠ¤íƒ€ì¼ */
.execution-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}

.execution-summary-card {
  padding: 20px;
  border-radius: 14px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.execution-summary-card.total {
  background: linear-gradient(135deg, #4f6fdc 0%, #3b5bdb 100%);
  color: #fff;
}

.execution-summary-card.kuk {
  background: linear-gradient(135deg, #f0f4ff 0%, #e9edfb 100%);
  border: 2px solid #3b5bdb;
  color: #3b5bdb;
}

.execution-summary-card.si {
  background: linear-gradient(135deg, #fff9f0 0%, #ffe8d6 100%);
  border: 2px solid #d26900;
  color: #d26900;
}

.execution-summary-card .label {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
  opacity: 0.9;
}

.execution-summary-card .budget-details {
  font-size: 12px;
  margin-bottom: 12px;
  opacity: 0.85;
  line-height: 1.8;
}

.execution-summary-card .rate {
  font-size: 32px;
  font-weight: 900;
  margin: 8px 0;
}

.execution-summary-card .spent-and-balance {
  font-size: 12px;
  margin-top: 8px;
  opacity: 0.8;
  line-height: 1.8;
}

/* ë©”ì¸ í™”ë©´ ì˜ˆì‚° í˜„í™© ìš”ì•½ */
.main-budget-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  padding: 30px 20px;
  margin-top: 30px;
}

.main-budget-card {
  background: #fff;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  text-align: center;
}

.main-budget-card.total {
  background: linear-gradient(135deg, #4f6fdc 0%, #3b5bdb 100%);
  color: #fff;
}

.main-budget-card.kuk {
  background: linear-gradient(135deg, #f0f4ff 0%, #e9edfb 100%);
  border: 2px solid #3b5bdb;
  color: #3b5bdb;
}

.main-budget-card.si {
  background: linear-gradient(135deg, #fff9f0 0%, #ffe8d6 100%);
  border: 2px solid #d26900;
  color: #d26900;
}

.main-budget-card .card-label {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  opacity: 0.9;
}

.main-budget-card .budget-item {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  margin-bottom: 8px;
  line-height: 1.6;
}

.main-budget-card .budget-item-label {
  text-align: left;
  flex: 1;
  opacity: 0.85;
}

.main-budget-card .budget-item-value {
  text-align: right;
  font-weight: 700;
}

.main-budget-card .rate-container {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.main-budget-card.total .rate-container {
  border-top-color: rgba(255, 255, 255, 0.3);
}

.main-budget-card .rate-label {
  font-size: 11px;
  opacity: 0.8;
  margin-bottom: 6px;
}

.main-budget-card .rate-value {
  font-size: 28px;
  font-weight: 900;
}

/* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
.progress-bar {
  width: 100%;
  height: 6px;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 3px;
  margin-top: 10px;
  overflow: hidden;
}

.main-budget-card.total .progress-bar {
  background: rgba(255, 255, 255, 0.3);
}

.progress-fill {
  height: 100%;
  background: #4f6fdc;
  border-radius: 3px;
  transition: width 0.3s ease;
}

.main-budget-card.kuk .progress-fill {
  background: #3b5bdb;
}

.main-budget-card.si .progress-fill {
  background: #d26900;
}

.main-budget-card.total .progress-fill {
  background: #fff;
}
</style>
</head>
<body>

<!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal">
  <div class="modal-content">
    <h3>ê´€ë¦¬ì ì¸ì¦</h3>
    <input type="password" id="pwInput" placeholder="ì•”í˜¸ ì…ë ¥" onkeyup="if(window.event.keyCode==13){checkPassword()}">
    <div style="display: flex; gap: 10px; justify-content: center; margin-top:15px;">
      <button onclick="checkPassword()" style="background:#4f6fdc; color:#fff;">í™•ì¸</button>
      <button onclick="closeLogin()" style="background:#eee; color:#333;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<header>
  <div>
    <span class="logo" onclick="goMain()">ê´‘ì£¼ìƒê³µíšŒì˜ì†Œ í˜‘ë ¥ì‚¬ì—…ë³¸ë¶€</span>
    <span id="adminStatus" class="admin-badge">ê´€ë¦¬ì ëª¨ë“œ</span>
  </div>
</header>

<main>
  <!-- [ë©”ì¸ í™”ë©´] -->
  <section id="screenMain" class="active">
    <div class="dashboard">
      <button class="dash-btn" onclick="openLabor()"><span>ğŸ‘¤</span>ì¸ê±´ë¹„ ê´€ë¦¬</button>
      <button class="dash-btn" onclick="openBiz()"><span>ğŸ’¼</span>ì‚¬ì—… ê´€ë¦¬</button>
      <button class="dash-btn" onclick="openBudget()"><span class="budget-icon">ğŸ’µ</span>ì˜ˆì‚° ê´€ë¦¬</button>
    </div>

    <!-- ë©”ì¸ í™”ë©´ ì˜ˆì‚° í˜„í™© ìš”ì•½ -->
    <div class="main-budget-summary">
      <div class="main-budget-card total">
        <div class="card-label">ğŸ“Š ì „ì²´ ì˜ˆì‚° í˜„í™©</div>
        <div class="budget-item">
          <div class="budget-item-label">ì˜ˆì‚°ì•¡</div>
          <div class="budget-item-value" id="mainTotalBudget">0ì›</div>
        </div>
        <div class="budget-item">
          <div class="budget-item-label">ì§‘í–‰ì•¡</div>
          <div class="budget-item-value" id="mainTotalSpent">0ì›</div>
        </div>
        <div class="budget-item">
          <div class="budget-item-label">ì”ì•¡</div>
          <div class="budget-item-value" id="mainTotalBalance">0ì›</div>
        </div>
        <div class="rate-container">
          <div class="rate-label">ì§‘í–‰ë¥ </div>
          <div class="rate-value" id="mainTotalRate">0.0%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="mainTotalProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="main-budget-card kuk">
        <div class="card-label">ğŸ›ï¸ êµ­ë¹„ ì˜ˆì‚° í˜„í™©</div>
        <div class="budget-item">
          <div class="budget-item-label">ì˜ˆì‚°ì•¡</div>
          <div class="budget-item-value" id="mainKukBudget">0ì›</div>
        </div>
        <div class="budget-item">
          <div class="budget-item-label">ì§‘í–‰ì•¡</div>
          <div class="budget-item-value" id="mainKukSpent">0ì›</div>
        </div>
        <div class="budget-item">
          <div class="budget-item-label">ì”ì•¡</div>
          <div class="budget-item-value" id="mainKukBalance">0ì›</div>
        </div>
        <div class="rate-container">
          <div class="rate-label">ì§‘í–‰ë¥ </div>
          <div class="rate-value" id="mainKukRate">0.0%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="mainKukProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="main-budget-card si">
        <div class="card-label">ğŸ¢ ì‹œë¹„ ì˜ˆì‚° í˜„í™©</div>
        <div class="budget-item">
          <div class="budget-item-label">ì˜ˆì‚°ì•¡</div>
          <div class="budget-item-value" id="mainSiBudget">0ì›</div>
        </div>
        <div class="budget-item">
          <div class="budget-item-label">ì§‘í–‰ì•¡</div>
          <div class="budget-item-value" id="mainSiSpent">0ì›</div>
        </div>
        <div class="budget-item">
          <div class="budget-item-label">ì”ì•¡</div>
          <div class="budget-item-value" id="mainSiBalance">0ì›</div>
        </div>
        <div class="rate-container">
          <div class="rate-label">ì§‘í–‰ë¥ </div>
          <div class="rate-value" id="mainSiRate">0.0%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="mainSiProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- [ì‚¬ì—… ê´€ë¦¬ í™”ë©´ - ì¤€ë¹„ì¤‘] -->
  <section id="screenBiz">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>ğŸ’¼ ì‚¬ì—… ê´€ë¦¬</h2>
        <button onclick="goMain()" style="background:#666; color:#fff;">ë’¤ë¡œê°€ê¸°</button>
      </div>
      <div style="text-align:center; padding:50px; border:2px dashed #ddd; border-radius:20px; color:#999;">
        <span style="font-size:40px;">ğŸ—ï¸</span>
        <p>ì‚¬ì—… ê´€ë¦¬ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘</p>
      </div>
    </div>
  </section>

  <!-- [ì˜ˆì‚° ê´€ë¦¬ í™”ë©´] -->
  <section id="screenBudget">
    <div class="nav">
      <button class="budget-tab active" onclick="switchBudgetTab('bgStatus', this)">ì˜ˆì‚°í˜„í™©</button>
      <button class="budget-tab" onclick="switchBudgetTab('bgAnalysis', this)">ì›”ë³„ì§‘í–‰(í•­ëª©ë³„)</button>
      <button class="budget-tab" onclick="switchBudgetTab('bgHistory', this)">ì§€ì¶œë‚´ì—­</button>
      <button onclick="goMain()" style="margin-left:auto; background:#666; color:#fff;">ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <!-- [íƒ­1] ì˜ˆì‚°í˜„í™© -->
    <div id="bgStatus" class="budget-section">
      <!-- ì§‘í–‰ë¥  ìš”ì•½ ì„¹ì…˜ -->
      <div class="execution-summary">
        <div class="execution-summary-card total">
          <div class="label">ğŸ“Š ì „ì²´ ì˜ˆì‚°</div>
          <div class="budget-details">
            <div id="totalBudgetAmount">0ì›</div>
          </div>
          <div class="rate" id="totalExecutionRate">0.0%</div>
          <div class="spent-and-balance">
            <div>ì§‘í–‰ì•¡: <span id="totalSpentAmount">0ì›</span></div>
            <div>ì”ì•¡: <span id="totalBalanceAmount">0ì›</span></div>
          </div>
        </div>

        <div class="execution-summary-card kuk">
          <div class="label">ğŸ›ï¸ êµ­ë¹„ ì˜ˆì‚°</div>
          <div class="budget-details">
            <div id="kukBudgetAmount">0ì›</div>
          </div>
          <div class="rate" id="kukExecutionRate">0.0%</div>
          <div class="spent-and-balance">
            <div>ì§‘í–‰ì•¡: <span id="kukSpentAmount">0ì›</span></div>
            <div>ì”ì•¡: <span id="kukBalanceAmount">0ì›</span></div>
          </div>
        </div>

        <div class="execution-summary-card si">
          <div class="label">ğŸ¢ ì‹œë¹„ ì˜ˆì‚°</div>
          <div class="budget-details">
            <div id="siBudgetAmount">0ì›</div>
          </div>
          <div class="rate" id="siExecutionRate">0.0%</div>
          <div class="spent-and-balance">
            <div>ì§‘í–‰ì•¡: <span id="siSpentAmount">0ì›</span></div>
            <div>ì”ì•¡: <span id="siBalanceAmount">0ì›</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“Š ì˜ˆì‚° ì§‘í–‰ í˜„í™©</h2>
        <div style="margin-bottom:10px; text-align:right; font-size:13px; color:#666;">* ì§‘í–‰ì•¡ì€ 'ì§€ì¶œë‚´ì—­' íƒ­ì˜ ë°ì´í„°ê°€ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</div>
        <table>
          <thead>
            <tr>
              <th>ì¬ì›</th>
              <th>ë¹„ëª©</th>
              <th>ì„¸ëª©(ìƒì„¸)</th>
              <th>ì‚°ì¶œë‚´ì—­</th>
              <th>ì˜ˆì‚°ì•¡(A)</th>
              <th>ì§‘í–‰ì•¡(B)</th>
              <th>ì”ì•¡(A-B)</th>
              <th>ì§‘í–‰ë¥ (%)</th>
            </tr>
          </thead>
          <tbody id="statusTableBody"></tbody>
          <tfoot>
            <tr class="total-cell" id="statusTableFoot"></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- [íƒ­2] ì›”ë³„ì§‘í–‰(í•­ëª©ë³„) -->
    <div id="bgAnalysis" class="budget-section" style="display:none">
      <div class="card">
        <h2>ğŸ“… ì›”ë³„ ì§‘í–‰ í˜„í™©(í•­ëª©ë³„)</h2>
        <div style="font-size:13px; color:#666; margin-top:6px;">
          * ì˜¬í•´ ê¸°ì¤€ìœ¼ë¡œ, ì¬ì›/ë¹„ëª©/ì„¸ëª© í•­ëª©ë³„ ì›” ì§€ì¶œ í•©ê³„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        </div>

        <div class="card" style="padding:12px; margin-top:14px; background:#f8faff; border:1px solid #e5e8f0;">
          <div style="display:flex; gap:14px; flex-wrap:wrap; font-weight:700; color:#4f6fdc;">
            <div>ì˜¬í•´ ì´ ì§‘í–‰: <span id="yearTotalSpent">0</span>ì›</div>
            <div>ì „ì²´ ì˜ˆì‚°: <span id="yearTotalBudget">0</span>ì›</div>
            <div>ì§‘í–‰ë¥ : <span id="yearRatio">0%</span></div>
          </div>
        </div>

        <div style="overflow:auto; margin-top:14px; border:1px solid #e6e9f2; border-radius:12px;">
          <table style="min-width:1200px; margin-top:0;">
            <thead id="monthlyItemHead"></thead>
            <tbody id="monthlyItemBody"></tbody>
            <tfoot id="monthlyItemFoot"></tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- [íƒ­3] ì§€ì¶œë‚´ì—­ -->
    <div id="bgHistory" class="budget-section" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
          <div>
            <h2 style="margin:0;">ğŸ“ ì§€ì¶œ ë‚´ì—­ì„œ</h2>
            <div style="font-size:12px; color:#666; margin-top:6px;">
              * ë¹„ëª©ì´ <b>ì¸ê±´ë¹„</b>ì¸ ê²½ìš°: <b>ë¹„ê³ </b>ì— ì´ë¦„ì„ ì ìœ¼ë©´ ê¸‰ì—¬ê´€ë¦¬(ì¸ê±´ë¹„ ê´€ë¦¬)ë¡œ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.
            </div>
          </div>
          <button onclick="addExpenseRow()" style="background:#4f6fdc; color:#fff;">+ ë‚´ì—­ ì¶”ê°€</button>
        </div>

        <!-- ê²€ìƒ‰/í•„í„°: ì¬ì›/ë¹„ëª©/ì„¸ëª©ë§Œ -->
        <div class="filter-bar">
          <div class="filter-item">
            <label>ì¬ì›</label>
            <select id="fFund" onchange="refreshExpenseFilterSubOptions(); applyExpenseFilters()">
              <option value="ì „ì²´">ì „ì²´</option>
              <option value="êµ­ë¹„">êµ­ë¹„</option>
              <option value="ì‹œë¹„">ì‹œë¹„</option>
            </select>
          </div>

          <div class="filter-item">
            <label>ë¹„ëª©</label>
            <select id="fCat" onchange="refreshExpenseFilterSubOptions(); applyExpenseFilters()">
              <option value="ì „ì²´">ì „ì²´</option>
              <option value="ì¸ê±´ë¹„">ì¸ê±´ë¹„</option>
              <option value="ì§ì ‘ì‚¬ì—…ë¹„">ì§ì ‘ì‚¬ì—…ë¹„</option>
              <option value="ê°„ì ‘ì‚¬ì—…ë¹„">ê°„ì ‘ì‚¬ì—…ë¹„</option>
            </select>
          </div>

          <div class="filter-item">
            <label>ì„¸ëª©</label>
            <select id="fSub" onchange="applyExpenseFilters()">
              <option value="ì „ì²´">ì „ì²´</option>
            </select>
          </div>

          <div class="filter-actions">
            <button onclick="resetExpenseFilters()" style="background:#fff; border:1px solid #dcdfea; color:#666;">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="filter-summary">
          <div class="summary-item count">
            ê²€ìƒ‰ ê²°ê³¼: <span id="expenseFilterCount">0</span> / <span id="expenseFilterTotal">0</span>
          </div>
          <div class="summary-item sum">
            í•©ê³„: <span id="expenseFilterSum">0</span>ì›
          </div>
        </div>

        <table>
          <colgroup>
            <col width="10%"><col width="8%"><col width="10%"><col width="10%"><col width="15%"><col width="15%"><col width="12%"><col width="12%"><col width="8%">
          </colgroup>
          <thead>
            <tr>
              <th>ë‚ ì§œ</th><th>ì¬ì›</th><th>ë¹„ëª©</th><th>ì„¸ëª©</th><th>ì‚°ì¶œë‚´ì—­</th><th>ì ìš”</th><th>ì§€ì¶œê¸ˆì•¡</th><th>ë¹„ê³ (ì´ë¦„)</th><th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="expenseBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- [ì¸ê±´ë¹„ ê´€ë¦¬ í™”ë©´] -->
  <section id="screenLabor">
    <div class="nav">
      <button class="tab active" data-tab="personal">ê°œì¸ë³„ í˜„í™©</button>
      <button class="tab" data-tab="month">ì›”ë³„ í˜„í™©</button>
      <button class="tab admin-tab" data-tab="payroll" style="display:none">ê¸‰ì—¬ê´€ë¦¬</button>
      <button class="tab admin-tab" data-tab="agency" style="display:none">ê¸°ê´€ë¶€ë‹´ê¸ˆ</button>
      <button onclick="goMain()" style="margin-left:auto; background:#666; color:#fff;">ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <div id="personal" class="sub-section">
      <div class="card">
        <h2>ğŸ‘¤ ê°œì¸ë³„ ëˆ„ì  í˜„í™©</h2>
        <table>
          <thead>
            <tr>
              <th rowspan="2">ì´ë¦„</th>
              <th colspan="2" class="bg-kuk">êµ­ë¹„ ëˆ„ì </th>
              <th colspan="2" class="bg-si">ì‹œë¹„ ëˆ„ì </th>
              <th rowspan="2">ì´ ì§€ì¶œ í•©ê³„</th>
            </tr>
            <tr>
              <th class="bg-kuk">ê¸‰ì—¬</th><th class="bg-kuk">ê¸°ê´€ë¶€ë‹´</th>
              <th class="bg-si">ê¸‰ì—¬</th><th class="bg-si">ê¸°ê´€ë¶€ë‹´</th>
            </tr>
          </thead>
          <tbody id="personalBody"></tbody>

          <!-- âœ… ìš”ì²­ ë°˜ì˜: 1) ê¸‰ì—¬/ê¸°ê´€ë¶€ë‹´ í•©ê³„(ë¶„ë¦¬) 2) ê·¸ ì•„ë˜ êµ­ë¹„ì´ê³„/ì‹œë¹„ì´ê³„ -->
          <tfoot>
            <tr class="total-cell" id="personalFoot1"></tr>
            <tr class="total-cell" id="personalFoot2"></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="month" class="sub-section" style="display:none">
      <div class="card">
        <h2>ğŸ“… ì›”ë³„ ìƒì„¸ í˜„í™©</h2>
        <div class="summary"><div id="sumPayroll"></div><div id="sumAgency"></div></div>
        <div id="statusMonthTabs" class="month-tabs"></div>
        <div id="monthDetail" style="display:none; margin-top:20px; padding:20px; border:1px dashed #4f6fdc; border-radius:16px;">
          <h3 id="selectedMonthTitle" style="color:#4f6fdc"></h3>
          <div id="monthDataArea"></div>
        </div>
      </div>
    </div>

    <!-- ê¸‰ì—¬ê´€ë¦¬: ì§€ì¶œë‚´ì—­(ì¸ê±´ë¹„)ì—ì„œ ìë™ ìƒì„± -->
    <div id="payroll" class="sub-section" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
          <div>
            <h2 style="margin:0;">ğŸ’° ê¸‰ì—¬ê´€ë¦¬</h2>
            <div style="font-size:12px; color:#666; margin-top:6px;">
              * ì˜ˆì‚° ê´€ë¦¬ &gt; ì§€ì¶œë‚´ì—­ì—ì„œ <b>ë¹„ëª©=ì¸ê±´ë¹„</b>ë¡œ ì…ë ¥í•œ ë‚´ì—­ì´ ì›”ë³„ë¡œ ìë™ í•©ì‚°ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.<br>
              * ì´ë¦„ì€ ì§€ì¶œë‚´ì—­ì˜ <b>ë¹„ê³ </b>ì— ì…ë ¥í•˜ì„¸ìš”.
            </div>
          </div>
        </div>
        <div id="payrollTabs" class="month-tabs"></div>
        <table>
          <thead><tr><th>êµ¬ë¶„</th><th>ì´ë¦„</th><th>ê¸°ë³¸ê¸‰(ìë™)</th><th>ê³µì œ(0)</th><th>ì‹¤ì§€ê¸‰</th><th>ë¹„ê³ </th></tr></thead>
          <tbody id="payrollBody"></tbody>
          <tfoot id="payrollFoot"></tfoot>
        </table>
      </div>
    </div>

    <div id="agency" class="sub-section" style="display:none">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ğŸ¥ ê¸°ê´€ë¶€ë‹´ê¸ˆ</h2>
          <button onclick="addAgency()" style="background:#4f6fdc; color:#fff;">ì§ì› ì¶”ê°€</button>
        </div>
        <div id="agencyTabs" class="month-tabs"></div>
        <table>
          <thead><tr><th>êµ¬ë¶„</th><th>ì´ë¦„</th><th>êµ­ë¯¼</th><th>ê±´ê°•</th><th>ê³ ìš©</th><th>ì‚°ì¬</th><th>í•©ê³„</th><th>ì‚­ì œ</th></tr></thead>
          <tbody id="agencyBody"></tbody>
          <tfoot id="agencyFoot"></tfoot>
        </table>
      </div>
    </div>
  </section>
</main>

<footer>
  <img src="ê´‘ì£¼ìƒì˜.png" class="admin-login-img" id="adminBtn" onclick="handleAdminClick()" alt="ê´€ë¦¬ì ë¡œê·¸ì¸">
</footer>

<script>
// ===== [0. DOM ì°¸ì¡°(ë¸Œë¼ìš°ì € ì „ì—­ id ì˜ì¡´ ìµœì†Œí™”)] =====
const payrollBody = document.getElementById("payrollBody");
const payrollFoot = document.getElementById("payrollFoot");
const agencyBody  = document.getElementById("agencyBody");
const agencyFoot  = document.getElementById("agencyFoot");

// ===== [ê³µí†µ ìœ í‹¸] =====
function stripNonDigits(v){ return String(v ?? "").replace(/[^\d]/g, ""); }
function toInt(v){ return parseInt(stripNonDigits(v), 10) || 0; }
function makeId(){ return "e_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10); }
function getMonthFromDateStr(d){
  const parts = String(d||"").split("-");
  const m = parseInt(parts[1],10);
  return (m>=1 && m<=12) ? m : null;
}

// ì§‘í–‰ë¥  ê³„ì‚° í•¨ìˆ˜ (ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼)
function calculateExecutionRate(spent, budget) {
  if (budget === 0) return 0;
  const rate = (spent / budget) * 100;
  return Math.round(rate * 10) / 10;
}

// ===== [ì§€ì¶œë‚´ì—­ ê¸ˆì•¡: ì½¤ë§ˆ ìë™ ì…ë ¥ + ì €ì¥ ë””ë°”ìš´ìŠ¤] =====
let expSaveTimer = null;
function formatAmtInput(inputEl){
  const raw = stripNonDigits(inputEl.value);
  if(!raw){ inputEl.value = ""; return; }
  inputEl.value = parseInt(raw, 10).toLocaleString();
}
function scheduleSaveExp(){
  clearTimeout(expSaveTimer);
  expSaveTimer = setTimeout(() => saveExpFromTable(), 200);
}

// ===== [1. ê³µí†µ ë° ë„¤ë¹„ê²Œì´ì…˜] =====
let isAdmin = false;
const ADMIN_PW = "1234";

function showScreen(screenId) {
  ['screenMain', 'screenLabor', 'screenBiz', 'screenBudget'].forEach(id => {
    document.getElementById(id).style.display = "none";
  });
  document.getElementById(screenId).style.display = "block";
}
function goMain(){ showScreen('screenMain'); updateMainBudgetSummary(); }
function openLabor(){ showScreen('screenLabor'); renderPersonal(); updateSummary(); }
function openBiz(){ showScreen('screenBiz'); }
function openBudget(){ showScreen('screenBudget'); renderBudgetStatus(); renderAnalysis(); }

// ===== [2. ê´€ë¦¬ì ëª¨ë“œ] =====
function handleAdminClick() {
  if (isAdmin) {
    if(confirm("ê´€ë¦¬ì ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { isAdmin = false; applyAdminMode(); }
  } else {
    document.getElementById('loginModal').style.display = 'flex';
    document.getElementById('pwInput').focus();
  }
}
function closeLogin() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('pwInput').value = '';
}
function checkPassword() {
  if (document.getElementById('pwInput').value === ADMIN_PW) {
    isAdmin = true; closeLogin(); applyAdminMode();
  } else {
    alert("ì•”í˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  }
}
function applyAdminMode() {
  document.querySelectorAll('.admin-tab').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
  document.getElementById('adminStatus').style.display = isAdmin ? 'inline-block' : 'none';
}

// ===== [3. ì¸ê±´ë¹„ ê´€ë¦¬ ë¡œì§] =====
let curP=1, curA=1;
const P=m=>JSON.parse(localStorage.getItem("payroll_"+m))||[];
const A=m=>JSON.parse(localStorage.getItem("agency_"+m))||[];

document.querySelectorAll(".tab").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll(".sub-section").forEach(s=>s.style.display="none");
    document.getElementById(b.dataset.tab).style.display="block";

    if(b.dataset.tab === "personal") renderPersonal();
    if(b.dataset.tab === "month") renderMonthStatusTabs();
    if(b.dataset.tab === "payroll") renderPayrollForMonth(curP);
  }
});

function monthTabs(id,cb){
  const el=document.getElementById(id); el.innerHTML="";
  for(let i=1;i<=12;i++){
    const b=document.createElement("button"); b.textContent=i+"ì›”";
    b.onclick=()=>{cb(i);[...el.children].forEach(x=>x.classList.remove("active"));b.classList.add("active")};
    el.appendChild(b);
  }
  if(el.children.length > 0) el.children[0].click();
}

// ê¸‰ì—¬ê´€ë¦¬ ë Œë”(ì½ê¸° ì „ìš©)
function renderPayrollForMonth(m){
  curP = m;
  payrollBody.innerHTML = "";
  const rows = P(m);

  let sum=0;
  rows.forEach(r=>{
    const net = (toInt(r.base) - toInt(r.ded));
    sum += net;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.type || ""}</td>
      <td style="font-weight:700;">${r.name || ""}</td>
      <td style="text-align:right;">${toInt(r.base).toLocaleString()}</td>
      <td style="text-align:right; color:#999;">0</td>
      <td style="text-align:right; font-weight:800; color:#4f6fdc;">${net.toLocaleString()}</td>
      <td style="color:#999; font-size:12px;">ì§€ì¶œë‚´ì—­(ì¸ê±´ë¹„) ìë™</td>
    `;
    payrollBody.appendChild(tr);
  });

  payrollFoot.innerHTML = `
    <tr>
      <td colspan="4" style="text-align:right; font-weight:700;">ì›” í•©ê³„:</td>
      <td style="text-align:right; font-weight:800; color:#4f6fdc;">${sum.toLocaleString()}</td>
      <td></td>
    </tr>
  `;
}

// ê¸°ê´€ë¶€ë‹´ê¸ˆ(ìˆ˜ë™ ìœ ì§€)
function addAgency(d={}){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>
      <select onchange="saveAgency()">
        <option ${d.type==='êµ­ë¹„'?'selected':''}>êµ­ë¹„</option>
        <option ${d.type==='ì‹œë¹„'?'selected':''}>ì‹œë¹„</option>
      </select>
    </td>
    <td><input type="text" value="${d.name||""}" oninput="saveAgency()"></td>
    <td><input type="number" value="${d.n||0}" oninput="saveAgency()"></td>
    <td><input type="number" value="${d.h||0}" oninput="saveAgency()"></td>
    <td><input type="number" value="${d.e||0}" oninput="saveAgency()"></td>
    <td><input type="number" value="${d.i||0}" oninput="saveAgency()"></td>
    <td class="sum">0</td>
    <td><button onclick="this.closest('tr').remove();saveAgency()" style="background:#ffe3e3; color:#e03131;">ì‚­ì œ</button></td>`;
  agencyBody.appendChild(tr);
  saveAgency();
}
function saveAgency(){
  let arr=[],sum=0;
  agencyBody.querySelectorAll("tr").forEach(tr=>{
    const i=tr.querySelectorAll("input");
    const s=(+i[1].value)+(+i[2].value)+(+i[3].value)+(+i[4].value);
    tr.querySelector(".sum").textContent=s.toLocaleString(); sum+=s;
    arr.push({type:tr.querySelector("select").value,name:i[0].value,n:+i[1].value,h:+i[2].value,e:+i[3].value,i:+i[4].value});
  });
  localStorage.setItem("agency_"+curA,JSON.stringify(arr));
  agencyFoot.innerHTML=`<tr><td colspan="6" style="text-align:right; font-weight:700;">ì›” í•©ê³„:</td><td style="font-weight:700; color:#d26900;">${sum.toLocaleString()}</td><td></td></tr>`;
}

function updateSummary(){
  let sp=0, sa=0;
  for(let m=1;m<=12;m++){
    sp += P(m).reduce((x,r)=>x+(toInt(r.base)-toInt(r.ded)),0);
    sa += A(m).reduce((x,r)=>x+toInt(r.n)+toInt(r.h)+toInt(r.e)+toInt(r.i),0);
  }
  document.getElementById("sumPayroll").innerHTML = `<div class="card" style="background:#eef2ff; color:#4f6fdc">ì—°ê°„ ê¸‰ì—¬ í•©ê³„: <strong>${sp.toLocaleString()}ì›</strong></div>`;
  document.getElementById("sumAgency").innerHTML = `<div class="card" style="background:#fff1e6; color:#d26900">ì—°ê°„ ê¸°ê´€ë¶€ë‹´ê¸ˆ í•©ê³„: <strong>${sa.toLocaleString()}ì›</strong></div>`;
}

function renderPersonal(){
  const body = document.getElementById("personalBody"); body.innerHTML = "";
  const foot1 = document.getElementById("personalFoot1");
  const foot2 = document.getElementById("personalFoot2");

  let userMap = {};

  // í•©ê³„(ë¶„ë¦¬)
  let sumKp=0, sumKa=0, sumSp=0, sumSa=0;

  for(let m=1;m<=12;m++){
    P(m).forEach(r=>{
      if(r.name){
        if(!userMap[r.name]) userMap[r.name]={kp:0, ka:0, sp:0, sa:0};
        const net = toInt(r.base)-toInt(r.ded);
        if(r.type==='êµ­ë¹„') userMap[r.name].kp+=net;
        else userMap[r.name].sp+=net;
      }
    });
    A(m).forEach(r=>{
      if(r.name){
        if(!userMap[r.name]) userMap[r.name]={kp:0, ka:0, sp:0, sa:0};
        const s=(toInt(r.n)+toInt(r.h)+toInt(r.e)+toInt(r.i));
        if(r.type==='êµ­ë¹„') userMap[r.name].ka+=s;
        else userMap[r.name].sa+=s;
      }
    });
  }

  Object.keys(userMap).sort().forEach(n=>{
    const d=userMap[n];
    const total=d.kp+d.ka+d.sp+d.sa;

    sumKp += d.kp;
    sumKa += d.ka;
    sumSp += d.sp;
    sumSa += d.sa;

    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="font-weight:bold">${n}</td>
      <td class="bg-kuk">${d.kp.toLocaleString()}ì›</td>
      <td class="bg-kuk">${d.ka.toLocaleString()}ì›</td>
      <td class="bg-si">${d.sp.toLocaleString()}ì›</td>
      <td class="bg-si">${d.sa.toLocaleString()}ì›</td>
      <td class="total-cell">${total.toLocaleString()}ì›</td>`;
    body.appendChild(tr);
  });

  const kukTotal = sumKp + sumKa;
  const siTotal  = sumSp + sumSa;
  const grand    = kukTotal + siTotal;

  // âœ… 1í–‰: ê¸‰ì—¬/ê¸°ê´€ë¶€ë‹´ í•©ê³„(ë¶„ë¦¬)
  if (foot1) {
    foot1.innerHTML = `
      <td style="text-align:center;">í•©ê³„</td>
      <td class="bg-kuk" style="font-weight:900;">${sumKp.toLocaleString()}ì›</td>
      <td class="bg-kuk" style="font-weight:900;">${sumKa.toLocaleString()}ì›</td>
      <td class="bg-si"  style="font-weight:900;">${sumSp.toLocaleString()}ì›</td>
      <td class="bg-si"  style="font-weight:900;">${sumSa.toLocaleString()}ì›</td>
      <td class="total-cell" style="font-weight:900;">${grand.toLocaleString()}ì›</td>
    `;
  }

  // âœ… 2í–‰: êµ­ë¹„ ì´ê³„ / ì‹œë¹„ ì´ê³„ (ìš”ì²­ëŒ€ë¡œ)
  if (foot2) {
    foot2.innerHTML = `
      <td style="text-align:center;">ì´ê³„</td>
      <td class="bg-kuk" colspan="2" style="font-weight:900;">êµ­ë¹„ ì´ê³„: ${kukTotal.toLocaleString()}ì›</td>
      <td class="bg-si"  colspan="2" style="font-weight:900;">ì‹œë¹„ ì´ê³„: ${siTotal.toLocaleString()}ì›</td>
      <td class="total-cell" style="font-weight:900;">${grand.toLocaleString()}ì›</td>
    `;
  }
}

function renderMonthStatusTabs(){
  const container = document.getElementById("statusMonthTabs"); container.innerHTML = "";
  for(let i=1; i<=12; i++){
    const b = document.createElement("button"); b.textContent = i + "ì›”";
    b.onclick = () => { [...container.children].forEach(x=>x.classList.remove("active")); b.classList.add("active"); showMonthDetail(i); };
    container.appendChild(b);
  }
  if(container.children.length > 0) container.children[0].click();
}
function showMonthDetail(m){
  const area = document.getElementById("monthDataArea"), title = document.getElementById("selectedMonthTitle");
  document.getElementById("monthDetail").style.display = "block";
  title.textContent = m + "ì›” ì§€ì¶œ ë‚´ì—­";

  const p = P(m), a = A(m);
  const ps = p.reduce((x,r)=>x+(toInt(r.base)-toInt(r.ded)),0);
  const as = a.reduce((x,r)=>x+toInt(r.n)+toInt(r.h)+toInt(r.e)+toInt(r.i),0);

  area.innerHTML = `<div style="margin-bottom:15px; font-weight:bold;">ì›” ì´ì•¡: ${(ps+as).toLocaleString()}ì›</div>
    <strong>ê¸‰ì—¬</strong>
    <table><tr><th>êµ¬ë¶„</th><th>ì´ë¦„</th><th>ì‹¤ì§€ê¸‰</th></tr>
      ${p.map(r=>`<tr><td>${r.type}</td><td>${r.name}</td><td>${(toInt(r.base)-toInt(r.ded)).toLocaleString()}ì›</td></tr>`).join("") || "<tr><td colspan=3>ë‚´ì—­ ì—†ìŒ</td></tr>"}
    </table><br>
    <strong>ê¸°ê´€ë¶€ë‹´ê¸ˆ</strong>
    <table><tr><th>êµ¬ë¶„</th><th>ì´ë¦„</th><th>í•©ê³„</th></tr>
      ${a.map(r=>`<tr><td>${r.type}</td><td>${r.name}</td><td>${(toInt(r.n)+toInt(r.h)+toInt(r.e)+toInt(r.i)).toLocaleString()}ì›</td></tr>`).join("") || "<tr><td colspan=3>ë‚´ì—­ ì—†ìŒ</td></tr>"}
    </table>`;
}

// ===== [4. ì˜ˆì‚° ê´€ë¦¬ ë¡œì§] =====
const budgetStructure = [
  { fund:"êµ­ë¹„", cat:"ì¸ê±´ë¹„", sub:"ì¸ê±´ë¹„", calc:"", plan:100000000 },
  { fund:"êµ­ë¹„", cat:"ì§ì ‘ì‚¬ì—…ë¹„", sub:"ì¼ë°˜ìˆ˜ìš©ë¹„", calc:"", plan:150000000 },
  { fund:"êµ­ë¹„", cat:"ì§ì ‘ì‚¬ì—…ë¹„", sub:"ì‚¬ì—…ì¶”ì§„ë¹„", calc:"", plan:30000000 },
  { fund:"êµ­ë¹„", cat:"ì§ì ‘ì‚¬ì—…ë¹„", sub:"ê¸°íƒ€ë³´ì „ê¸ˆ", calc:"", plan:20000000 },
  { fund:"êµ­ë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"ì¼ë°˜ìˆ˜ìš©ë¹„", calc:"", plan:10000000 },
  { fund:"êµ­ë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"êµ­ë‚´ì—¬ë¹„", calc:"", plan:10000000 },
  { fund:"êµ­ë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"ê³ ìš©ë¶€ë‹´ê¸ˆ", calc:"", plan:5000000 },
  { fund:"êµ­ë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"ê³µê³µìš”ê¸ˆ/ì œì„¸", calc:"", plan:5000000 },
  { fund:"ì‹œë¹„", cat:"ì¸ê±´ë¹„", sub:"ì¸ê±´ë¹„", calc:"", plan:50000000 },
  { fund:"ì‹œë¹„", cat:"ì§ì ‘ì‚¬ì—…ë¹„", sub:"ì¼ë°˜ìˆ˜ìš©ë¹„", calc:"", plan:80000000 },
  { fund:"ì‹œë¹„", cat:"ì§ì ‘ì‚¬ì—…ë¹„", sub:"ì‚¬ì—…ì¶”ì§„ë¹„", calc:"", plan:20000000 },
  { fund:"ì‹œë¹„", cat:"ì§ì ‘ì‚¬ì—…ë¹„", sub:"ê¸°íƒ€ë³´ì „ê¸ˆ", calc:"", plan:10000000 },
  { fund:"ì‹œë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"ì¼ë°˜ìˆ˜ìš©ë¹„", calc:"", plan:5000000 },
  { fund:"ì‹œë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"íŠ¹ê·¼ë§¤ì‹ë¹„", calc:"", plan:2000000 },
  { fund:"ì‹œë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"ê³ ìš©ë¶€ë‹´ê¸ˆ", calc:"", plan:1500000 },
  { fund:"ì‹œë¹„", cat:"ê°„ì ‘ì‚¬ì—…ë¹„", sub:"ê³µê³µìš”ê¸ˆ/ì œì„¸", calc:"", plan:1500000 }
];

// ì˜ˆì‚°ì•¡(plan) localStorage ì €ì¥/ë¡œë“œ (ì˜¬í•´ ê¸°ì¤€)
const BUDGET_PLAN_KEY = `budgetPlans_${new Date().getFullYear()}`;
const budgetKeyOf = (fund, cat, sub) => `${fund}||${cat}||${sub}`;
function saveBudgetPlans() {
  const plans = {};
  budgetStructure.forEach(item => {
    plans[budgetKeyOf(item.fund, item.cat, item.sub)] = { plan: item.plan, calc: item.calc };
  });
  localStorage.setItem(BUDGET_PLAN_KEY, JSON.stringify({ v: 1, updatedAt: Date.now(), plans }));
}
function loadBudgetPlans() {
  const raw = localStorage.getItem(BUDGET_PLAN_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    const plans = (data && data.plans) ? data.plans : {};
    budgetStructure.forEach(item => {
      const k = budgetKeyOf(item.fund, item.cat, item.sub);
      if (plans[k]) {
        if (plans[k].plan != null && !Number.isNaN(parseInt(plans[k].plan, 10))) {
          item.plan = parseInt(plans[k].plan, 10);
        }
        if (plans[k].calc != null) {
          item.calc = plans[k].calc;
        }
      }
    });
  } catch (e) {}
}

const subCatOptions = {
  "êµ­ë¹„": { "ì¸ê±´ë¹„":["ì¸ê±´ë¹„"], "ì§ì ‘ì‚¬ì—…ë¹„":["ì¼ë°˜ìˆ˜ìš©ë¹„","ì‚¬ì—…ì¶”ì§„ë¹„","ê¸°íƒ€ë³´ì „ê¸ˆ"], "ê°„ì ‘ì‚¬ì—…ë¹„":["ì¼ë°˜ìˆ˜ìš©ë¹„","êµ­ë‚´ì—¬ë¹„","ê³ ìš©ë¶€ë‹´ê¸ˆ","ê³µê³µìš”ê¸ˆ/ì œì„¸"] },
  "ì‹œë¹„": { "ì¸ê±´ë¹„":["ì¸ê±´ë¹„"], "ì§ì ‘ì‚¬ì—…ë¹„":["ì¼ë°˜ìˆ˜ìš©ë¹„","ì‚¬ì—…ì¶”ì§„ë¹„","ê¸°íƒ€ë³´ì „ê¸ˆ"], "ê°„ì ‘ì‚¬ì—…ë¹„":["ì¼ë°˜ìˆ˜ìš©ë¹„","íŠ¹ê·¼ë§¤ì‹ë¹„","ê³ ìš©ë¶€ë‹´ê¸ˆ","ê³µê³µìš”ê¸ˆ/ì œì„¸"] }
};

// ì§€ì¶œ ë°ì´í„° ì €ì¥/ë¡œë“œ
const getExp = () => JSON.parse(localStorage.getItem("expenses")) || [];
const setExp = (arr) => localStorage.setItem("expenses", JSON.stringify(arr));

function switchBudgetTab(targetId, btn) {
  document.querySelectorAll('.budget-section').forEach(el => el.style.display = 'none');
  document.getElementById(targetId).style.display = 'block';
  document.querySelectorAll('.budget-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  if(targetId === 'bgStatus') renderBudgetStatus();
  if(targetId === 'bgAnalysis') renderAnalysis();
  if(targetId === 'bgHistory') applyExpenseFilters();
}

// rowspan ê³„ì‚°(ì¬ì›/ë¹„ëª© ë°˜ë³µ í‘œì‹œ ì œê±°ìš©)
function buildRowspans(items) {
  const fundCount = {};
  const catCount = {}; // key: fund||cat
  items.forEach(it => {
    fundCount[it.fund] = (fundCount[it.fund] || 0) + 1;
    const ck = `${it.fund}||${it.cat}`;
    catCount[ck] = (catCount[ck] || 0) + 1;
  });
  return { fundCount, catCount, seenFund: new Set(), seenCat: new Set() };
}

// ì§€ì¶œë‚´ì—­(ì¸ê±´ë¹„) -> ê¸‰ì—¬ê´€ë¦¬ ìë™ ë™ê¸°í™”
function syncPayrollFromExpenses() {
  const exps = getExp();
  const perMonth = new Map();
  for (let m=1; m<=12; m++) perMonth.set(m, new Map());

  exps.forEach(e => {
    if (e.cat !== "ì¸ê±´ë¹„") return;
    const m = getMonthFromDateStr(e.date);
    if (!m) return;

    const name = String(e.note || "").trim();
    if (!name) return;

    const fund = e.fund || "êµ­ë¹„";
    const amt = toInt(e.amt);

    const key = `${fund}||${name}`;
    const mm = perMonth.get(m);
    mm.set(key, (mm.get(key) || 0) + amt);
  });

  for (let m=1; m<=12; m++){
    const mm = perMonth.get(m);
    const arr = [...mm.entries()]
      .map(([key, sum]) => {
        const [type, name] = key.split("||");
        return { type, name, base: sum, ded: 0, src: "expense_labor" };
      })
      .sort((a,b)=> (a.type+a.name).localeCompare(b.type+b.name, "ko"));
    localStorage.setItem("payroll_"+m, JSON.stringify(arr));
  }

  const payrollSection = document.getElementById("payroll");
  if (payrollSection && payrollSection.style.display !== "none") renderPayrollForMonth(curP);
}

// ë©”ì¸ í™”ë©´ ì˜ˆì‚° ìš”ì•½ ì—…ë°ì´íŠ¸
function updateMainBudgetSummary() {
  const allExp = getExp();
  let totPlan=0, totExec=0;
  let kukPlan=0, kukExec=0, siPlan=0, siExec=0;

  budgetStructure.forEach(item => {
    const spent = allExp
      .filter(e => e.fund === item.fund && e.cat === item.cat && e.sub === item.sub)
      .reduce((acc, curr) => acc + toInt(curr.amt), 0);

    totPlan += item.plan;
    totExec += spent;

    if (item.fund === "êµ­ë¹„") {
      kukPlan += item.plan;
      kukExec += spent;
    } else {
      siPlan += item.plan;
      siExec += spent;
    }
  });

  const totalRate = calculateExecutionRate(totExec, totPlan);
  const kukRate = calculateExecutionRate(kukExec, kukPlan);
  const siRate = calculateExecutionRate(siExec, siPlan);
  const totalBalance = totPlan - totExec;
  const kukBalance = kukPlan - kukExec;
  const siBalance = siPlan - siExec;

  // ì „ì²´
  document.getElementById("mainTotalBudget").textContent = totPlan.toLocaleString() + "ì›";
  document.getElementById("mainTotalSpent").textContent = totExec.toLocaleString() + "ì›";
  document.getElementById("mainTotalBalance").textContent = totalBalance.toLocaleString() + "ì›";
  document.getElementById("mainTotalRate").textContent = totalRate.toFixed(1) + "%";
  document.getElementById("mainTotalProgress").style.width = Math.min(totalRate, 100) + "%";

  // êµ­ë¹„
  document.getElementById("mainKukBudget").textContent = kukPlan.toLocaleString() + "ì›";
  document.getElementById("mainKukSpent").textContent = kukExec.toLocaleString() + "ì›";
  document.getElementById("mainKukBalance").textContent = kukBalance.toLocaleString() + "ì›";
  document.getElementById("mainKukRate").textContent = kukRate.toFixed(1) + "%";
  document.getElementById("mainKukProgress").style.width = Math.min(kukRate, 100) + "%";

  // ì‹œë¹„
  document.getElementById("mainSiBudget").textContent = siPlan.toLocaleString() + "ì›";
  document.getElementById("mainSiSpent").textContent = siExec.toLocaleString() + "ì›";
  document.getElementById("mainSiBalance").textContent = siBalance.toLocaleString() + "ì›";
  document.getElementById("mainSiRate").textContent = siRate.toFixed(1) + "%";
  document.getElementById("mainSiProgress").style.width = Math.min(siRate, 100) + "%";
}

// ì˜ˆì‚°í˜„í™© ë Œë”ë§
function renderBudgetStatus() {
  const tbody = document.getElementById("statusTableBody"); tbody.innerHTML = "";
  const tfoot = document.getElementById("statusTableFoot");
  const allExp = getExp();
  let totPlan=0, totExec=0;
  let kukPlan=0, kukExec=0, siPlan=0, siExec=0;

  const { fundCount, catCount, seenFund, seenCat } = buildRowspans(budgetStructure);

  budgetStructure.forEach((item, idx) => {
    const spent = allExp
      .filter(e => e.fund === item.fund && e.cat === item.cat && e.sub === item.sub)
      .reduce((acc, curr) => acc + toInt(curr.amt), 0);

    const balance = item.plan - spent;
    const executionRate = calculateExecutionRate(spent, item.plan);
    
    const tr = document.createElement("tr");

    if (!seenFund.has(item.fund)) {
      seenFund.add(item.fund);
      const tdFund = document.createElement("td");
      tdFund.className = item.fund === 'êµ­ë¹„' ? 'row-kuk' : 'row-si';
      tdFund.rowSpan = fundCount[item.fund];
      tdFund.textContent = item.fund;
      tr.appendChild(tdFund);
    }

    const catKey = `${item.fund}||${item.cat}`;
    if (!seenCat.has(catKey)) {
      seenCat.add(catKey);
      const tdCat = document.createElement("td");
      tdCat.className = "row-cat";
      tdCat.rowSpan = catCount[catKey];
      tdCat.textContent = item.cat;
      tr.appendChild(tdCat);
    }

    const tdSub = document.createElement("td");
    tdSub.className = "sub-item";
    tdSub.textContent = item.sub;
    tr.appendChild(tdSub);

    const tdCalc = document.createElement("td");
    tdCalc.innerHTML = `<input type="text" class="budget-calc" value="${item.calc || ''}" placeholder="ì‚°ì¶œë‚´ì—­" style="width:95%" onchange="updateCalc(${idx}, this.value)">`;
    tr.appendChild(tdCalc);

    const tdPlan = document.createElement("td");
    tdPlan.innerHTML = `<input type="text" class="budget-input" value="${item.plan.toLocaleString()}" onchange="updatePlan(${idx}, this.value)">`;
    tr.appendChild(tdPlan);

    const tdSpent = document.createElement("td");
    tdSpent.style.cssText = "color:#d9480f; font-weight:bold;";
    tdSpent.textContent = spent.toLocaleString();
    tr.appendChild(tdSpent);

    const tdBal = document.createElement("td");
    tdBal.style.cssText = "font-weight:bold;";
    tdBal.textContent = balance.toLocaleString();
    tr.appendChild(tdBal);

    const tdRate = document.createElement("td");
    let rateClass = "execution-rate low";
    if (executionRate >= 80) rateClass = "execution-rate high";
    else if (executionRate >= 50) rateClass = "execution-rate medium";
    tdRate.className = rateClass;
    tdRate.textContent = executionRate.toFixed(1) + "%";
    tr.appendChild(tdRate);

    tbody.appendChild(tr);
    totPlan += item.plan;
    totExec += spent;

    if (item.fund === "êµ­ë¹„") {
      kukPlan += item.plan;
      kukExec += spent;
    } else {
      siPlan += item.plan;
      siExec += spent;
    }
  });

  // ì§‘í–‰ë¥  ìš”ì•½ ì„¹ì…˜ ì—…ë°ì´íŠ¸
  const totalRate = calculateExecutionRate(totExec, totPlan);
  const kukRate = calculateExecutionRate(kukExec, kukPlan);
  const siRate = calculateExecutionRate(siExec, siPlan);
  const totalBalance = totPlan - totExec;
  const kukBalance = kukPlan - kukExec;
  const siBalance = siPlan - siExec;

  document.getElementById("totalBudgetAmount").textContent = totPlan.toLocaleString() + "ì›";
  document.getElementById("totalSpentAmount").textContent = totExec.toLocaleString() + "ì›";
  document.getElementById("totalBalanceAmount").textContent = totalBalance.toLocaleString() + "ì›";
  document.getElementById("totalExecutionRate").textContent = totalRate.toFixed(1) + "%";

  document.getElementById("kukBudgetAmount").textContent = kukPlan.toLocaleString() + "ì›";
  document.getElementById("kukSpentAmount").textContent = kukExec.toLocaleString() + "ì›";
  document.getElementById("kukBalanceAmount").textContent = kukBalance.toLocaleString() + "ì›";
  document.getElementById("kukExecutionRate").textContent = kukRate.toFixed(1) + "%";

  document.getElementById("siBudgetAmount").textContent = siPlan.toLocaleString() + "ì›";
  document.getElementById("siSpentAmount").textContent = siExec.toLocaleString() + "ì›";
  document.getElementById("siBalanceAmount").textContent = siBalance.toLocaleString() + "ì›";
  document.getElementById("siExecutionRate").textContent = siRate.toFixed(1) + "%";

  const totalRateClass = totalRate >= 80 ? "execution-rate high" : totalRate >= 50 ? "execution-rate medium" : "execution-rate low";
  const kukRateClass = kukRate >= 80 ? "execution-rate high" : kukRate >= 50 ? "execution-rate medium" : "execution-rate low";
  const siRateClass = siRate >= 80 ? "execution-rate high" : siRate >= 50 ? "execution-rate medium" : "execution-rate low";

  document.getElementById("totalExecutionRate").className = totalRateClass;
  document.getElementById("kukExecutionRate").className = kukRateClass;
  document.getElementById("siExecutionRate").className = siRateClass;

  const totalRateFootClass = totalRate >= 80 ? "execution-rate high" : totalRate >= 50 ? "execution-rate medium" : "execution-rate low";
  tfoot.innerHTML = `
    <td colspan="4">ì´ í•©ê³„</td>
    <td>${totPlan.toLocaleString()}</td>
    <td style="color:#d9480f;">${totExec.toLocaleString()}</td>
    <td>${totalBalance.toLocaleString()}</td>
    <td class="${totalRateFootClass}">${totalRate.toFixed(1)}%</td>`;
}

function updateCalc(idx, val) {
  budgetStructure[idx].calc = val;
  saveBudgetPlans();
}

function updatePlan(idx, val) {
  const num = toInt(val);
  budgetStructure[idx].plan = num;
  saveBudgetPlans();
  renderBudgetStatus();
  renderAnalysis();
  updateMainBudgetSummary();
}

// ì§€ì¶œë‚´ì—­: ê²€ìƒ‰/í•„í„°
function refreshExpenseFilterSubOptions(){
  const fFund = document.getElementById("fFund")?.value || "ì „ì²´";
  const fCat  = document.getElementById("fCat")?.value  || "ì „ì²´";
  const sel   = document.getElementById("fSub");
  if(!sel) return;

  const set = new Set();
  if (fFund !== "ì „ì²´" && fCat !== "ì „ì²´") {
    (subCatOptions[fFund]?.[fCat] || []).forEach(x => set.add(x));
  } else {
    Object.keys(subCatOptions).forEach(fund => {
      if (fFund !== "ì „ì²´" && fund !== fFund) return;
      Object.keys(subCatOptions[fund]).forEach(cat => {
        if (fCat !== "ì „ì²´" && cat !== fCat) return;
        subCatOptions[fund][cat].forEach(x => set.add(x));
      });
    });
  }

  const cur = sel.value || "ì „ì²´";
  sel.innerHTML = `<option value="ì „ì²´">ì „ì²´</option>` + [...set].map(x => `<option value="${x}">${x}</option>`).join("");
  sel.value = (cur && [...set].includes(cur)) ? cur : "ì „ì²´";
}
function resetExpenseFilters(){
  document.getElementById("fFund").value = "ì „ì²´";
  document.getElementById("fCat").value = "ì „ì²´";
  refreshExpenseFilterSubOptions();
  document.getElementById("fSub").value = "ì „ì²´";
  applyExpenseFilters();
}
function applyExpenseFilters(){
  refreshExpenseFilterSubOptions();
  const fund = document.getElementById("fFund")?.value || "ì „ì²´";
  const cat  = document.getElementById("fCat")?.value  || "ì „ì²´";
  const sub  = document.getElementById("fSub")?.value  || "ì „ì²´";

  const tbody = document.getElementById("expenseBody");
  if(!tbody) return;

  const rows = [...tbody.querySelectorAll("tr")];
  let shown = 0;
  let sum = 0;

  rows.forEach(tr => {
    const rFund = tr.querySelector(".fund-select")?.value || "";
    const rCat  = tr.querySelector(".cat-select")?.value || "";
    const rSub  = tr.querySelector(".sub-select")?.value || "";

    let ok = true;
    if (fund !== "ì „ì²´" && rFund !== fund) ok = false;
    if (cat !== "ì „ì²´" && rCat !== cat) ok = false;
    if (sub !== "ì „ì²´" && rSub !== sub) ok = false;

    tr.style.display = ok ? "table-row" : "none";
    if (ok) {
      shown += 1;
      sum += toInt(tr.querySelector(".i-amt").value);
    }
  });

  // ê²€ìƒ‰ ê²°ê³¼ ë° í•©ê³„ ì—…ë°ì´íŠ¸
  document.getElementById("expenseFilterCount").textContent = shown;
  document.getElementById("expenseFilterTotal").textContent = rows.length;
  document.getElementById("expenseFilterSum").textContent = sum.toLocaleString();
}

// ì§€ì¶œë‚´ì—­: ì¶”ê°€/ì €ì¥
function addExpenseRow(d=null) {
  const tr = document.createElement("tr");
  const today = new Date().toISOString().substring(0, 10);

  const id = (d && d.id) ? d.id : makeId();
  const initAmt = d && d.amt != null && toInt(d.amt) !== 0 ? toInt(d.amt).toLocaleString() : "";
  tr.dataset.id = id;

  tr.innerHTML = `
    <td><input type="date" value="${d?d.date:today}" class="i-date" onchange="saveExpFromTable()"></td>
    <td>
      <select class="budget-select fund-select" onchange="updateSubCats(this);saveExpFromTable(); applyExpenseFilters()">
        <option>êµ­ë¹„</option><option>ì‹œë¹„</option>
      </select>
    </td>
    <td>
      <select class="budget-select cat-select" onchange="updateSubCats(this);saveExpFromTable(); applyExpenseFilters()">
        <option>ì¸ê±´ë¹„</option><option selected>ì§ì ‘ì‚¬ì—…ë¹„</option><option>ê°„ì ‘ì‚¬ì—…ë¹„</option>
      </select>
    </td>
    <td><select class="budget-select sub-select" onchange="saveExpFromTable(); applyExpenseFilters()"></select></td>
    <td><input type="text" value="${d?d.calc:''}" class="i-calc" placeholder="ì‚°ì¶œë‚´ì—­" style="width:95%" oninput="saveExpFromTable()"></td>
    <td><input type="text" value="${d?d.desc:''}" class="i-desc" placeholder="ë‚´ì—­" style="width:95%" oninput="saveExpFromTable()"></td>
    <td>
      <input type="text" inputmode="numeric" value="${initAmt}" class="i-amt" placeholder="0"
        style="text-align:right; width:90%"
        oninput="formatAmtInput(this); scheduleSaveExp(); applyExpenseFilters()"
        onchange="saveExpFromTable(); applyExpenseFilters()">
    </td>
    <td><input type="text" value="${d?d.note:''}" class="i-note" style="width:90%" placeholder="ì˜ˆ: í™ê¸¸ë™" oninput="saveExpFromTable()"></td>
    <td><button onclick="this.closest('tr').remove();saveExpFromTable(); applyExpenseFilters()" style="background:#ffe3e3; color:#e03131; padding:4px 8px; font-size:12px;">ì‚­ì œ</button></td>
  `;
  document.getElementById("expenseBody").appendChild(tr);

  if(d) {
    tr.querySelector(".fund-select").value = d.fund || "êµ­ë¹„";
    tr.querySelector(".cat-select").value  = d.cat  || "ì§ì ‘ì‚¬ì—…ë¹„";
    updateSubCats(tr.querySelector(".fund-select"));
    tr.querySelector(".sub-select").value  = d.sub  || tr.querySelector(".sub-select").value;
  } else {
    updateSubCats(tr.querySelector(".fund-select"));
  }

  applyExpenseFilters();
}

function updateSubCats(el) {
  const tr = el.closest("tr");
  const fund = tr.querySelector(".fund-select").value;
  const cat  = tr.querySelector(".cat-select").value;
  const subSelect = tr.querySelector(".sub-select");

  const items = (subCatOptions[fund] && subCatOptions[fund][cat]) ? subCatOptions[fund][cat] : [];
  const oldVal = subSelect.value;

  subSelect.innerHTML = "";
  items.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item;
    opt.textContent = item;
    subSelect.appendChild(opt);
  });

  if (items.includes(oldVal)) subSelect.value = oldVal;
}

function saveExpFromTable() {
  const rows = document.getElementById("expenseBody").querySelectorAll("tr");
  let arr = [];
  rows.forEach(tr => {
    const id = tr.dataset.id || (tr.dataset.id = makeId());
    arr.push({
      id,
      date: tr.querySelector(".i-date").value,
      fund: tr.querySelector(".fund-select").value,
      cat:  tr.querySelector(".cat-select").value,
      sub:  tr.querySelector(".sub-select").value,
      calc: tr.querySelector(".i-calc").value,
      desc: tr.querySelector(".i-desc").value,
      amt:  toInt(tr.querySelector(".i-amt").value),
      note: tr.querySelector(".i-note").value
    });
  });

  setExp(arr);

  syncPayrollFromExpenses();
  renderBudgetStatus();
  renderAnalysis();
  updateMainBudgetSummary();

  const laborVisible = document.getElementById("screenLabor")?.style.display !== "none";
  if (laborVisible) { updateSummary(); renderPersonal(); }
}

// ì›”ë³„ì§‘í–‰(í•­ëª©ë³„) í‘œ ë Œë”
function renderMonthlyByItem() {
  const exps = getExp();
  const year = new Date().getFullYear();

  const keyOf = (fund, cat, sub) => `${fund}||${cat}||${sub}`;
  const sums = new Map();

  budgetStructure.forEach(item => sums.set(keyOf(item.fund, item.cat, item.sub), new Array(13).fill(0)));

  exps.forEach(e => {
    const parts = (e.date || "").split("-");
    const y = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    if (y !== year || !(m >= 1 && m <= 12)) return;

    const amt = toInt(e.amt);
    const k = keyOf(e.fund, e.cat, e.sub);

    if (!sums.has(k)) sums.set(k, new Array(13).fill(0));
    sums.get(k)[m] += amt;
  });

  const head = document.getElementById("monthlyItemHead");
  head.innerHTML = `
    <tr>
      <th>ì¬ì›</th><th>ë¹„ëª©</th><th>ì„¸ëª©</th><th>ì˜ˆì‚°ì•¡</th>
      ${Array.from({length:12}, (_,i)=>`<th>${i+1}ì›”</th>`).join("")}
      <th>ì—°ê°„í•©ê³„</th><th>ì”ì•¡</th>
    </tr>
  `;

  const body = document.getElementById("monthlyItemBody");
  body.innerHTML = "";

  const { fundCount, catCount, seenFund, seenCat } = buildRowspans(budgetStructure);

  let totalBudget = 0;
  let totalSpent = 0;
  const monthTotals = new Array(13).fill(0);

  budgetStructure.forEach(item => {
    const k = keyOf(item.fund, item.cat, item.sub);
    const arr = sums.get(k) || new Array(13).fill(0);

    const rowSum = arr.slice(1).reduce((a,b)=>a+b,0);
    const balance = item.plan - rowSum;

    totalBudget += item.plan;
    totalSpent  += rowSum;
    for (let mm=1; mm<=12; mm++) monthTotals[mm] += (arr[mm] || 0);

    const tr = document.createElement("tr");

    if (!seenFund.has(item.fund)) {
      seenFund.add(item.fund);
      const tdFund = document.createElement("td");
      tdFund.className = item.fund === 'êµ­ë¹„' ? 'row-kuk' : 'row-si';
      tdFund.rowSpan = fundCount[item.fund];
      tdFund.textContent = item.fund;
      tr.appendChild(tdFund);
    }

    const catKey = `${item.fund}||${item.cat}`;
    if (!seenCat.has(catKey)) {
      seenCat.add(catKey);
      const tdCat = document.createElement("td");
      tdCat.className = "row-cat";
      tdCat.rowSpan = catCount[catKey];
      tdCat.textContent = item.cat;
      tr.appendChild(tdCat);
    }

    tr.insertAdjacentHTML("beforeend", `
      <td class="sub-item">${item.sub}</td>
      <td style="text-align:right; font-weight:700;">${item.plan.toLocaleString()}</td>
      ${Array.from({length:12},(_,i)=>{
        const v = arr[i+1] || 0;
        return `<td style="text-align:right; ${v ? 'font-weight:700; color:#d9480f;' : 'color:#999;'}">${v ? v.toLocaleString() : '-'}</td>`;
      }).join("")}
      <td style="text-align:right; font-weight:800; color:#4f6fdc;">${rowSum.toLocaleString()}</td>
      <td style="text-align:right; font-weight:800;">${balance.toLocaleString()}</td>
    `);

    body.appendChild(tr);
  });

  document.getElementById("monthlyItemFoot").innerHTML = `
    <tr class="total-cell">
      <td colspan="4">ì›”ë³„ í•©ê³„</td>
      ${Array.from({length:12},(_,i)=>`<td style="text-align:right;">${monthTotals[i+1].toLocaleString()}</td>`).join("")}
      <td style="text-align:right;">${totalSpent.toLocaleString()}</td>
      <td style="text-align:right;">${(totalBudget-totalSpent).toLocaleString()}</td>
    </tr>
  `;

  document.getElementById("yearTotalSpent").textContent = totalSpent.toLocaleString();
  document.getElementById("yearTotalBudget").textContent = totalBudget.toLocaleString();
  const ratio = totalBudget ? (totalSpent/totalBudget*100) : 0;
  document.getElementById("yearRatio").textContent = (Math.round(ratio * 10) / 10).toFixed(1) + "%";
}
function renderAnalysis() { renderMonthlyByItem(); }

// ===== ì´ˆê¸° ë¡œë”© =====
loadBudgetPlans();

// ì§€ì¶œë‚´ì—­ ë¡œë“œ(id ë§ˆì´ê·¸ë ˆì´ì…˜ í¬í•¨)
const loadedExp = getExp().map(e => (e && e.id) ? e : ({...e, id: makeId()}));
setExp(loadedExp);
loadedExp.forEach(d => addExpenseRow(d));

// ì§€ì¶œë‚´ì—­ -> ê¸‰ì—¬ ìë™ ë™ê¸°í™”(ì´ˆê¸° 1íšŒ)
syncPayrollFromExpenses();

// ì¸ê±´ë¹„ íƒ­(ì›”ë³„ ë²„íŠ¼)
monthTabs("payrollTabs",m=>{ renderPayrollForMonth(m); });

// ê¸°ê´€ë¶€ë‹´ê¸ˆ ì›” íƒ­(ê¸°ì¡´ ë¡œì§ ìœ ì§€)
monthTabs("agencyTabs",m=>{curA=m; agencyBody.innerHTML=""; A(curA).forEach(addAgency); saveAgency();});

// ì§€ì¶œ í•„í„° ì´ˆê¸°í™”
refreshExpenseFilterSubOptions();
applyExpenseFilters();

// ë©”ì¸ í™”ë©´ ì˜ˆì‚° ìš”ì•½ ì´ˆê¸°í™”
updateMainBudgetSummary();
</script>
</body>
</html>
